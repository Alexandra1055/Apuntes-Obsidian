---
id: 01K9521R3YFZ6CF6CSZJAZCS75
---
 **Crear VPC**
 **crear 2 subnets**
 - **publica asociado internet gateway amb rute table publica**
 - **privada asociado nat gateway amb rute table privada**

**nat va associat a la xarxa publica.**

**les ips publiques desde 0 a 128.**

**security grup a de tenir ssh y ping y mysql/aurora per a la bd.**

****

### 1. Crear una VPC
- **Accedeix a la consola de AWS** y  a "VPC".
- Selecciona **"Create VPC"**.
- Defineix:
	- **nom:** vpc_books
	- **IPv4 CIDR:** 192.168.30.0/24
### 2. Crear Subnets

- Ve a **"Subnets"** y selecciona **"Create subnet"**.
- Crea dos subrnets:
    - **Subnet Pública**:
        - Nom: web-subnet
        - CIDR: **192.168.30.0/25** (Aixó proporciona 128 direccions IP).
        - Asocía aquesta subnet a la taula de rutes pública.
    - **Subred Privada**:
        - Nombre: db-subnet
        - CIDR: **192.168.30.128/25**.
        - Asocía aquesta subnet a la taula de rutes privada.

### 3. Crear una Internet Gateway

### 3. Crear y Configurar una Gateway NAT

- En la secció de **NAT Gateways**, eligeix **"Create NAT Gateway"**.
- La subnet a de ser la pública
- Asigna una Elastic IP.

### 4. Configurar las Tablas de Ruta

- **Tabla de Rutas Pública**:
	- Nom: ruta_publica_web
	- VPC: l’vpc creat
	- Per configurar, seleccionar la Taula de Rutes, anar a Routes i a Edit Routes:
		- Add  route:
		    - Destino: **0.0.0.0/0**
		    - Target: **igw-1234567890abcdef0** (Internet Gateway).
- **Tabla de Rutas Privada**:
    - Destí: **0.0.0.0/0**
    - Target: **NAT Gateway**

### 5. Instàncies EC2

- Ve a la consola de EC2 y selecciona **"Launch Instances"**.
- Crea una instancia per:
    - **Servidor Web** en la subnet pública:
        - Màquina: debian
        - Network: edit
	        - vpc: vpc_books
	        - subnet: web-subnet
	        - auto-assign public ip: enable
        - Security Group:
	        - Create security group
		        - ssh
		        - http
    - **Servidor DB** en la subnet privada:
        - Màquina: debian
        - Network: edit
	        - vpc: vpc_books
	        - subnet: db-subnet
	        - auto-assign public ip: disable
        - Security Group:
	        - Create security group
		        - ssh
		        - mysql/aurora


# Preparar les instancies

## Instància amb la base de dades

Passar la key, la base de dades i la carpeta d’imatges a l’instancia d’apache desde windows:
```bash
scp -i "vockey.pem" vockey.pem admin@54.160.142.172:/home/admin
scp -i "vockey.pem" books.sql admin@54.160.142.172:/home/admin
scp -i "vockey.pem" -r images admin@54.160.142.172:/home/admin
```

Connectarte a l’instància de la base de dades desde l’instancia d’apache:
```bash
#connectarte a l'instància apache
ssh -i "vockey.pem" admin@54.160.142.172 #per entrar a l'apache

#canviar l'accés a la clau per poder usarla  
chmod 400 vockey.pem

#passar la base de dades al db
scp -i "vockey.pem" books.sql admin@192.168.30.135:/home/admin

#connectarte a la base de dades desde l'instància apache
ssh -i "vockey.pem" admin@192.168.30.135
```

Configurar l’instància de la base de dades:
```bash
# desde dis l'instància de base de dades 
sudo apt update

# instal·lar dependències
sudo apt install -y mariadb-server mariadb-client
```

Crear la base de dades:
```bash
sudo mysql -uroot -p 

#crear la base de dades
CREATE DATABASE llibres CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
ALTER USER 'root'@'192.168.30.54' IDENTIFIED BY 'secret';  #ip privada apache
GRANT ALL PRIVILEGES ON llibres.*TO 'root'@'192.168.30.54';
FLUSH PRIVILEGES;
EXIT;

sudo mysql -uroot -p llibres < books.sql

#mirar que s'ha creat
sudo mysql -uroot -p 
use llibres;
show tables;
```

Canviar l’accés de 50-server.conf:
```bash
sudo nano /etc/mysql/mariadb.conf.d/50-server.cnf

#canviar el bind-address a 0.0.0.0  
bind-address = 0.0.0.0
```

Reiniciar el mariadb i mysql:
```bash
sudo systemctl restart mariadb
sudo systemctl restart mysql

```

Per mirar el port al que està escoltant:
```bash
ss -ntlp | grep 3306
```

## Instància amb l’apache

Instal·lar les dependències:
```bash
sudo apt install -y apache2 php libapache2-mod-php php-mysql git unzip mariadb-client
```

Crear la carptea per a la web i fer el git clone:
```bash
sudo mkdir -p /var/www/html/llibres-db
sudo git clone -b database --single-branch https://github.com/antonimoragues/llibres.git /var/www/html/llibres-db
```

Editar list.php:
```bash
cd /var/www/html/llibres-db
sudo nano list.php

# editar db_host per a la ip de la db
```

Possar les imatges a la carpeta corresponent:
```bash
# eliminar la carpeta buida d'imatges
sudo rm -r /var/www/html/llibres-db/images

# copiar la carpeta nova desde /home/admin
sudo cp -r images /var/www/html/llibres-db/

# canviar els permisos de la carpeta
sudo chmod 755 images
```

Telnet:
```bash
sudo apt install telnet
sudo telnet 192.168.30.135 3306
```